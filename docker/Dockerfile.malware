# Malware Analysis Environment for ARM64
FROM k3s-jupyter-base:latest

USER root

# Install malware analysis system packages
RUN apt-get update && apt-get install -y \
    # Analysis tools
    radare2 \
    binutils \
    gdb \
    strace \
    ltrace \
    # File utilities
    file \
    binwalk \
    foremost \
    exiftool \
    # Compression
    p7zip-full \
    unrar \
    # Network analysis
    tcpdump \
    wireshark-common \
    # Development
    nasm \
    gcc \
    g++ \
    make \
    cmake \
    # Libraries
    libssl-dev \
    libffi-dev \
    libmagic-dev \
    libcapstone-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create isolated directories for malware samples
RUN mkdir -p /opt/malware/{samples,quarantine,reports,yara-rules} && \
    chmod 700 /opt/malware/quarantine

# Switch to jupyter user
USER jupyter
WORKDIR /home/jupyter

# Copy environment file
COPY environments/malware/environment.yml /tmp/environment.yml

# Create conda environment
RUN conda env create -f /tmp/environment.yml && \
    conda clean --all -f -y && \
    rm /tmp/environment.yml

# Activate environment and install kernel
RUN /opt/conda/envs/jupyter-malware/bin/python -m ipykernel install \
    --user \
    --name malware \
    --display-name "Malware Analysis (ARM64)"

# Download YARA rules
RUN mkdir -p /home/jupyter/yara-rules && \
    cd /home/jupyter/yara-rules && \
    git clone https://github.com/Yara-Rules/rules.git yara-rules || true && \
    git clone https://github.com/Neo23x0/signature-base.git signature-base || true

# Create notebook directories
RUN mkdir -p notebooks/malware/{samples,analysis,reports,scripts,iocs}

# Copy analysis tools configuration
COPY environments/malware/analysis-tools/* /home/jupyter/.config/ || true

# Set environment variables
ENV CONDA_DEFAULT_ENV=jupyter-malware
ENV PATH=/opt/conda/envs/jupyter-malware/bin:$PATH
ENV MALWARE_SAMPLES=/opt/malware/samples
ENV YARA_RULES=/home/jupyter/yara-rules

# Security: Run with restricted permissions
USER jupyter
WORKDIR /home/jupyter/notebooks

CMD ["jupyter", "lab", "--ip=0.0.0.0", "--no-browser", "--allow-root"]